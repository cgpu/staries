# https://github.com/Slashgear/slashgear.github.io/blob/source/src/pages/how-to-split-test-by-folder-with-github-action/index.md
name: Iterate over directories
on:
  pull_request:
    types: [opened, reopened, synchronize, closed]
    paths:
    - 'containers/**'
jobs:
  directories: # Job that list subdirectories
    runs-on: ubuntu-latest
    outputs:
      dir: ${{ steps.set-dirs.outputs.dir }} # generate output name dir by using inner step output
    steps:
      - uses: actions/checkout@v2
      - id: set-dirs # Give it an id to handle to get step outputs in the outputs key above
        run: echo "::set-output name=dir::$(ls -d containers/*/ | jq -R -s -c 'split("\n")[:-1]')"
        # Define step output named dir base on ls command transformed to JSON thanks to jq
  loop:
    runs-on: ubuntu-latest
    needs: [directories] # Depends on previous job
    strategy:
      matrix:
        dir: ${{fromJson(needs.directories.outputs.dir)}} # List matrix strategy from directories dynamically
    steps:
      - name: Step that prints name of pull request's base branch
        env:
            BASE_BRANCH: ${{ github.base_ref }}
        run: |
          echo "Pull request's base branch is: ${BASE_BRANCH}"
        if: github.event_name == 'pull_request'
      - name: Step that prints name of pull request's github.head_ref
        env:
            HEAD_REF: ${{ github.head_ref }}
        run: |
          echo "Pull request's github.head_ref branch is: ${HEAD_REF}"
        if: github.event_name == 'pull_request'
      - name: Step stores boolean git diff decision
        run: |
            if git diff --quiet origin/${{ github.base_ref }} origin/${{ github.head_ref }} containers/${{matrix.dir}} ; then
                echo "there are NO changes in the folder between the branches and "
                echo "changes_exist=false" >> $GITHUB_ENV
            else
                echo "there ARE changes in the folder between the branches and"
                echo "changes_exist=true" >> $GITHUB_ENV
            fi        
      - name: List files
        if: ${{ env.changes_exist == 'true' }}
        run: |
          ls -l ${GITHUB_WORKSPACE}/${{matrix.dir}}
